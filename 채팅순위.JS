/*
ì±„íŒ…ìˆœìœ„
ì±„íŒ… ìˆ˜ì— ë”°ë¼ ë ˆë²¨ ë° ê²½í—˜ì¹˜ê°€ ì˜¤ë¥´ëŠ” ê¸°ëŠ¥

/ì±„íŒ…ìˆ˜: ìœ ì €ì˜ ì±„íŒ… ìˆ˜ ì¶œë ¥
/ì±„íŒ…ìˆœìœ„: ì¹´ì¹´ì˜¤í†¡ ì±„íŒ…ë°©ì˜ ì±„íŒ…ìˆœìœ„ ì¶œë ¥


"ì´ë”° ì½”ë“œ ì¶”ê°€"ë¼ëŠ” ì–´ë§ˆë¬´ì‹œí•œ ì£¼ì„ìˆëŠ”ë° ì‘ë™ì—¬ë¶€ëŠ” ì¥ë‹µëª»í•˜ê² ë‹¤.
ê·¸ë ‡ë‹¤ê³  ë””ë²„ê¹…í•˜ê¸°ì—” ê·€ì°®ìœ¼ë‹ˆ ë‚´ë¹„ë‘¬ì•¼ê² ë‹¤. 

*/

const FS = FileStream;
const directory = "/sdcard/ì±„íŒ…ìˆœìœ„/";

var roomUserData = {};

function getFilePath(room) {
    return directory + room + ".json";
}

function getUserData(room, userHash, sender) {
    if (!roomUserData[room]) {
        let path = getFilePath(room);
        if (!new java.io.File(path).canRead()) {
            FS.write(path, '{}');
        }
        roomUserData[room] = JSON.parse(FS.read(path));
    }
    if (!roomUserData[room][userHash]) {
        roomUserData[room][userHash] = {
            chatCount: 0
        };
    } else if (roomUserData[room][userHash].name !== sender) {
        roomUserData[room][userHash].name = sender;
    }
    return roomUserData[room][userHash];
}

function saveUserData(room) {
    let path = getFilePath(room);
    FS.write(path, JSON.stringify(roomUserData[room], null, 2));
}

function generateChatBar(percentage) {
    const totalBars = 10;
    const fullBars = Math.floor(percentage / 10);
    const partialBars = (percentage % 10 >= 5) ? 'â–ˆâ–‘' : '';
    const emptyBars = totalBars - fullBars - (partialBars ? 1 : 0);

    return 'â–ˆâ–ˆ'.repeat(fullBars) + partialBars + 'â–‘â–‘'.repeat(emptyBars);
}

function handleCommand(room, msg, sender, userHash, replier) {
    var user = getUserData(room, userHash, sender);

    if (msg === "/ì±„íŒ…ìˆ˜") {
        replier.reply("[" + user.name + "]ë‹˜ì˜ ì´ ì±„íŒ… ìˆ˜: " + user.chatCount);
        user.chatCount += 1;
        saveUserData(room);
    } else if (msg === "/ì±„íŒ…ìˆœìœ„") {
        var userList = roomUserData[room];
        var sortedUsers = Object.keys(userList).sort((a, b) => userList[b].chatCount - userList[a].chatCount);

        var totalChats = sortedUsers.reduce((sum, userHash) => sum + userList[userHash].chatCount, 0);
        var rankMessage = "ì±„íŒ… ìˆœìœ„:\nì´ ì±„íŒ… ìˆ˜: " + totalChats + "\n\n";
        sortedUsers.forEach((userHash, index) => {
            var rankPrefix = "";
            if (index === 0) rankPrefix = "ğŸ¥‡ ";
            else if (index === 1) rankPrefix = "ğŸ¥ˆ ";
            else if (index === 2) rankPrefix = "ğŸ¥‰ ";


            // ì´ë”° ì½”ë“œ ì¶”ê°€


            var rank = (index + 1) + "ìœ„";
            var user = userList[userHash];
            var chatCount = user.chatCount;
            var percentage = totalChats > 0 ? ((chatCount / totalChats) * 100).toFixed(2) : "0.00";
            var chatBar = generateChatBar(percentage)

            rankMessage += rankPrefix + rank + " | " + user.name + "\n";
            rankMessage += "ì±„íŒ… ìˆ˜ : " + chatCount + "íšŒ\n";
            rankMessage += "âŸ¦" + chatBar + "âŸ§ " + percentage + "%\n\n";
        });

        replier.reply(rankMessage.trim());
        user.chatCount += 1;
        saveUserData(room);
    } else {
        user.chatCount += 1;
        saveUserData(room);
    }
}

function response(room, msg, sender, replier, userHash) {
    handleCommand(room, msg, sender, userHash, replier);
}
