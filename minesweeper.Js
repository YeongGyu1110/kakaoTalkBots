/*
ì§€ë¢°ì°¾ê¸°
ì´ë¦„ë§Œ ì§€ë¢°ì°¾ê¸°ì§€ ì§€ë¢°ì°¾ê¸°ë‘ ìœ ì‚¬ì ì´ ì§€ë¢°ë°–ì— ì—†ë‹¤
ì‚¬ì‹¤ìƒ ë¯¸ë¡œê²œ

/ms: ê²Œì„ ì‹œì‘
/d: ë‚œì´ë„ ì¡°ì •
w,a,s,d: ì´ë™
/scan: ì£¼ë³€ 9ì¹¸ì„ ì˜¤í”ˆ
/r: ê²Œì„ ì¢…ë£Œ
/h: ë„ì›€ë§

*/

var playerRow = 0, playerCol = 0, boardWidth = 0, boardHeight = 0;
var visitedCells = [], losingCoordinates = [], answerBoard = [], openCells = [];
var gameStarted = false, difficulty = "2", isSettingDifficulty = false, invalidDifficultyCount = 0;

var mineRatioByDifficulty = {
    "1": { name: "ì‰¬ì›€", ratio: 0.1, scanLimit: 4 },
    "2": { name: "ë³´í†µ", ratio: 0.15, scanLimit: 4 },
    "3": { name: "ì–´ë ¤ì›€", ratio: 0.25, scanLimit: 2 },
    "4": { name: "ë§¤ìš° ì–´ë ¤ì›€", ratio: 0.25, scanLimit: 2 }
};


var commandKey = {
    "/ms": { name: "GameStart", ê¸°ëŠ¥: "startGame()", í˜¸ì¶œí‚¤: "/ms", ì„¤ëª…: "ê²Œì„ ì‹œì‘" },

    "/sc": { name: "scan", ê¸°ëŠ¥: "handleScanCommand(replier)", í˜¸ì¶œí‚¤: "/sc", ì„¤ëª…: "í”Œë ˆì´ì–´ ì£¼ë³€ 8ì¹¸ì„ ìŠ¤ìº”í•©ë‹ˆë‹¤." },
    "/scan": { name: "scan", ê¸°ëŠ¥: "handleScanCommand(replier)", í˜¸ì¶œí‚¤: "/scan", ì„¤ëª…: "" },
    "/ìŠ¤ìº”": { name: "scan", ê¸°ëŠ¥: "handleScanCommand(replier)", í˜¸ì¶œí‚¤: "/ìŠ¤ìº”", ì„¤ëª…: "" },

    "/d": { name: "Difficulty", ê¸°ëŠ¥: "checkIsSettingDifficulty = true", í˜¸ì¶œí‚¤: "/d", ì„¤ëª…: "ë‚œì´ë„ ë¶ˆëŸ¬ì˜¤ê¸° ë° ì„¤ì • í‚¤" },

    "/h": { name: "help", ê¸°ëŠ¥: "replier.rpely()", í˜¸ì¶œí‚¤: "/h", ì„¤ëª…: "ê²Œì„ì— í•„ìš”í•œ ê¸°ì´ˆ ì •ë³´ ì œê³µ" },

    "/r": { name: "restart", ê¸°ëŠ¥: "endGame()", í˜¸ì¶œí‚¤: "/r", ì„¤ëª…: "ê²Œì„ ê°•ì œ ì¢…ë£Œ" },
    "/ì¢…ë£Œ": { name: "restart", ê¸°ëŠ¥: "endGame()", í˜¸ì¶œí‚¤: "/ì¢…ë£Œ", ì„¤ëª…: "ê²Œì„ ê°•ì œ ì¢…ë£Œ" }
}

var scanLimit = mineRatioByDifficulty[difficulty].scanLimit;
var checkIsSettingDifficulty = false;
var checkDifficultySettingMSGYES = ["Y", "y", "ì˜ˆ"];
var checkDifficultySettingMSGNO = ["N", "n", "ì•„ë‹ˆìš”", "ì•„ë‹ˆì˜¤"];

function response(msg, replier) {
    function checkDifficultySettingMsgfun(msg, replier) {
        if (checkDifficultySettingMSGYES.includes(msg)) {
            isSettingDifficulty = true;
            checkIsSettingDifficulty = false;
            replier.reply("ìˆ«ìë¥¼ ì…ë ¥í•˜ì—¬ ë‚œì´ë„ë¥¼ ì„¤ì •í•˜ì„¸ìš”.\n1: ì‰¬ì›€\n2: ë³´í†µ\n3: ì–´ë ¤ì›€\n4: ë§¤ìš° ì–´ë ¤ì›€");
        } else if (checkDifficultySettingMSGNO.includes(msg)) {
            checkIsSettingDifficulty = false;
            replier.reply("ë‚œì´ë„ ë³€ê²½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            replier.reply("ì˜¬ë°”ë¥¸ ì‘ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ/ì•„ë‹ˆì˜¤)");
        }
    }

    function handleDifficultySetting(msg, replier) {
        if (msg in mineRatioByDifficulty) {
            difficulty = msg;
            isSettingDifficulty = false;
            invalidDifficultyCount = 0;
            var replyMessage = "ë‚œì´ë„ê°€ '" + mineRatioByDifficulty[difficulty].name + "'(ìœ¼)ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.";
            if (gameStarted) {
                gameStarted = false;
                replyMessage += " ë‹¤ì‹œ ì‹œì‘í•˜ë ¤ë©´ '/ì§€ë¢°ì°¾ê¸°'ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
            }
            replier.reply(replyMessage);
        } else {
            invalidDifficultyCount++;
            if (invalidDifficultyCount >= 2) {
                difficulty = "2";
                scanLimit = mineRatioByDifficulty[difficulty].scanLimit;
                isSettingDifficulty = false;
                invalidDifficultyCount = 0;
                var errorMessage = "ì˜¬ë°”ë¥´ì§€ ì•ŠëŠ” ë‚œì´ë„ë¥¼ 2ë²ˆ ì…ë ¥ë°›ì•˜ìŠµë‹ˆë‹¤.\nê¸°ë³¸ ë‚œì´ë„(ë³´í†µ)ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.";
                if (gameStarted) {
                    gameStarted = false;
                    errorMessage += " ë‹¤ì‹œ ì‹œì‘í•˜ë ¤ë©´ '/ì§€ë¢°ì°¾ê¸°'ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
                }
                replier.reply(errorMessage);
            } else {
                replier.reply("ë‚œì´ë„ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.\n1: ì‰¬ì›€\n2: ë³´í†µ\n3: ì–´ë ¤ì›€\n4: ë§¤ìš° ì–´ë ¤ì›€");
            }
        }
    }

    if (msg == "/ms") {
        startGame();
        replier.reply("Minesweeper:\n" + generateGameBoard(true) + "\në‚œì´ë„: " + mineRatioByDifficulty[difficulty].name);
    }

    if (msg === "/d") {
        checkIsSettingDifficulty = true;
        replier.reply("í˜„ì¬ ë‚œì´ë„ : '" + mineRatioByDifficulty[difficulty].name + "' ì…ë‹ˆë‹¤.\në‚œì´ë„ë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n)");
        return;
    }

    if (checkIsSettingDifficulty) {
        checkDifficultySettingMsgfun(msg, replier);
        return;
    }

    if (isSettingDifficulty) {
        handleDifficultySetting(msg, replier);
        return;
    }

    if (gameStarted && (msg === "/scan" || msg === "/sc" || msg === "/ìŠ¤ìº”")) {
        handleScanCommand(replier);
        return;
    }

    if (msg === "/he") {
        replier.reply(
            "Minesweeper ê²Œì„ ì„¤ëª…ì„œ\n\n" +
            "ê²Œì„ ê°œìš”\n" +
            "MinesweeperëŠ” ì§€ë¢°ë¥¼ í”¼í•˜ê³  ëª©í‘œ ì§€ì ì— ë„ë‹¬í•˜ëŠ” ê²Œì„ì…ë‹ˆë‹¤.\n" +
            "í”Œë ˆì´ì–´ëŠ” `w`, `a`, `s`, `d` í‚¤ë¥¼ ì‚¬ìš©í•´ ì´ë™í•˜ë©°,\n" +
            "ì£¼ì–´ì§„ ìŠ¤ìº” ê¸°íšŒë¥¼ í™œìš©í•´ ì£¼ë³€ ì¹¸ì„ íƒìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n\n" +
            "ëª…ë ¹ì–´ ì„¤ëª…\n\n" +
            "1. ê²Œì„ ì‹œì‘\n" +
            " - `/ms`\n" +
            "   ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤. ë‚œì´ë„ì— ë”°ë¼ ëœë¤í•œ í¬ê¸°ì˜ ë³´ë“œê°€ ìƒì„±ë˜ë©°,\n" +
            "   í”Œë ˆì´ì–´ëŠ” ë³´ë“œì˜ ì‹œì‘ì (0, 0)ì—ì„œ ì¶œë°œí•©ë‹ˆë‹¤.\n\n" +
            "2. ë‚œì´ë„ ì„¤ì •\n" +
            " - `/d`\n" +
            "   í˜„ì¬ ë‚œì´ë„ë¥¼ í™•ì¸í•˜ê³  ë³€ê²½í•  ìˆ˜ ìˆëŠ” ëª…ë ¹ì–´ì…ë‹ˆë‹¤.\n" +
            "   ì…ë ¥ í›„ `ì˜ˆ`ë¥¼ ì…ë ¥í•˜ë©´ ë‚œì´ë„ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n" +
            "   ë‚œì´ë„ ì…ë ¥ ì˜ˆì‹œ:\n" +
            "       1: ì‰¬ì›€ (ì§€ë¢° ë°€ë„ 10%, ìŠ¤ìº” íšŸìˆ˜ 4íšŒ)\n" +
            "       2: ë³´í†µ (ì§€ë¢° ë°€ë„ 15%, ìŠ¤ìº” íšŸìˆ˜ 4íšŒ)\n" +
            "       3: ì–´ë ¤ì›€ (ì§€ë¢° ë°€ë„ 25%, ìŠ¤ìº” íšŸìˆ˜ 2íšŒ)\n" +
            "       4: ë§¤ìš° ì–´ë ¤ì›€ (ì§€ë¢° ë°€ë„ 35%, ìŠ¤ìº” íšŸìˆ˜ 2íšŒ)\n\n" +
            "3. í”Œë ˆì´ì–´ ì´ë™\n" +
            " - `w`, `a`, `s`, `d`\n" +
            "   í”Œë ˆì´ì–´ë¥¼ ìƒí•˜ì¢Œìš°ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤.\n\n" +
            "4. ìŠ¤ìº”\n" +
            " - `/scan` ë˜ëŠ” `/ìŠ¤ìº”`\n" +
            "   í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì£¼ë³€ ì¹¸ì„ íƒìƒ‰í•©ë‹ˆë‹¤. ìŠ¤ìº” íšŸìˆ˜ëŠ” ë‚œì´ë„ì— ë”°ë¼ ì œí•œë˜ë©°,\n" +
            "   ìŠ¤ìº” í›„ ë‚¨ì€ íšŸìˆ˜ê°€ í‘œì‹œë©ë‹ˆë‹¤.\n\n" +
            "5. ê²Œì„ ì¢…ë£Œ\n" +
            "  - `/r` ë˜ëŠ” `/ì¢…ë£Œ`\n" +
            "   í˜„ì¬ ê²Œì„ì„ ì¦‰ì‹œ ì¢…ë£Œí•˜ê³  ë³´ë“œì˜ ëª¨ë“  ì§€ë¢° ìœ„ì¹˜ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.\n\n" +
            "6. ë„ì›€ë§\n" +
            " - `/help` ë˜ëŠ” `/h`\n" +
            "   ê²Œì„ì˜ ëª…ë ¹ì–´ì— ëŒ€í•œ ë„ì›€ë§ì„ í‘œì‹œí•©ë‹ˆë‹¤.\n\n\n" +
            "ê²Œì„ ë³´ë“œ ì„¤ëª…\n" +
            "   â–  : ì•„ì§ ì—´ë¦¬ì§€ ì•Šì€ ì¹¸\n" +
            "   â–¡ : ë°©ë¬¸í–ˆìœ¼ë‚˜ ì§€ë¢°ê°€ ì—†ëŠ” ì¹¸\n" +
            "   â˜… : í˜„ì¬ í”Œë ˆì´ì–´ì˜ ìœ„ì¹˜\n" +
            "   â–£ : ì§€ë¢°ê°€ ìˆëŠ” ì¹¸ (ìŠ¤ìº” í›„ ë˜ëŠ” ê²Œì„ ì¢…ë£Œ ì‹œ í‘œì‹œ)\n" +
            "   â—ˆ : ëª©í‘œ ì§€ì  (ë³´ë“œì˜ ë§ˆì§€ë§‰ ì¹¸)\n\n" +
            "ìŠ¹ë¦¬ ì¡°ê±´\n" +
            "   í”Œë ˆì´ì–´ëŠ” ë³´ë“œì˜ ì‹œì‘ì ì—ì„œ ì¶œë°œí•˜ì—¬ ì§€ë¢°ë¥¼ í”¼í•˜ê³ \n" +
            "   ë³´ë“œì˜ ë(ë§ˆì§€ë§‰ ì¹¸)ê¹Œì§€ ë„ë‹¬í•˜ë©´ ìŠ¹ë¦¬í•©ë‹ˆë‹¤.\n\n" +
            "íŒ¨ë°° ì¡°ê±´\n" +
            "   í”Œë ˆì´ì–´ê°€ ì´ë™ ì¤‘ ì§€ë¢°ë¥¼ ë°Ÿìœ¼ë©´ íŒ¨ë°°í•˜ê²Œ ë©ë‹ˆë‹¤.\n" +
            "   ê²Œì„ì´ ì¢…ë£Œë˜ë©° ëª¨ë“  ì§€ë¢° ìœ„ì¹˜ê°€ í‘œì‹œë©ë‹ˆë‹¤.\n\n" +
            "ì£¼ì˜ì‚¬í•­\n" +
            "   ê²Œì„ ì¤‘ ë‚œì´ë„ë¥¼ ë³€ê²½í•  ê²½ìš° í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ê²Œì„ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.\n" +
            "   ë‚œì´ë„ ì„¤ì • ì‹œ ì˜ëª»ëœ ì…ë ¥ì„ 2ë²ˆ ì´ìƒ í•  ê²½ìš° ê¸°ë³¸ ë‚œì´ë„(ë³´í†µ)ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤.\n\n\n" +
            "ì´ ì„¤ëª…ì„œë¥¼ í†µí•´ Minesweeper ê²Œì„ì„ ì¦ê²ê²Œ í”Œë ˆì´í•˜ì‹œê¸¸ ë°”ëë‹ˆë‹¤!"
        );
    }

    if (gameStarted && (msg === "/ì¢…ë£Œ" || msg === "/r")) {
        replier.reply("ìí­ë¨!\n" + generateSelfDestructAnswerBoard());
        endGame();
    }

    if (gameStarted && ["w", "a", "s", "d", "W", "A", "S", "D"].includes(msg)) {
        movePlayer(msg.toLowerCase());
        replier.reply("Minesweeper:\n" + generateGameBoard(true));
        checkEndings(replier);
    }

}


function startGame() {
    gameStarted = true;

    scanLimit = (mineRatioByDifficulty[difficulty].name == "ë§¤ìš° ì–´ë ¤ì›€") ? 2 : 4;

    initializeGameBoard();
    answerBoard = generateAnswerBoard();

}

function initializeGameBoard() {
    playerRow = 0;
    playerCol = 0;
    boardWidth = getRandomValueInRange(3, 9);
    boardHeight = getRandomValueInRange(3, 5);
    visitedCells = [];
    openCells = [];
    losingCoordinates = getLosingCoordinates();
}

function getLosingCoordinates() {
    var mineProbability = mineRatioByDifficulty[difficulty].ratio;
    var mineCount = Math.floor(boardWidth * boardHeight * mineProbability);
    var mines = [];
    while (mines.length < mineCount) {
        var randomRow = getRandomValueInRange(0, boardHeight - 1);
        var randomCol = getRandomValueInRange(0, boardWidth - 1);
        if (!isAdjacentToStartOrEnd(randomRow, randomCol) && !isEnd(randomRow, randomCol) &&
            !mines.some(coord => coord.row === randomRow && coord.col === randomCol)) {
            mines.push({ row: randomRow, col: randomCol });
        }
    }
    return mines;
}

function handleScanCommand(replier) {
    if (scanLimit <= 0) {
        replier.reply("ì£¼ì–´ì§„ ìŠ¤ìº” íšŸìˆ˜ë¥¼ ëª¨ë‘ ì†Œëª¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
        return;
    }

    exploreAndDisplay();
    scanLimit--;
    replier.reply("ìŠ¤ìº” ì™„ë£Œ:\n" + generateGameBoard(true) + "\në‚¨ì€ ìŠ¤ìº” íšŸìˆ˜: " + scanLimit);
}

function movePlayer(direction) {
    var newRow = playerRow, newCol = playerCol;
    if (direction === "w" && playerRow > 0) newRow--;
    if (direction === "a" && playerCol > 0) newCol--;
    if (direction === "s" && playerRow < boardHeight - 1) newRow++;
    if (direction === "d" && playerCol < boardWidth - 1) newCol++;
    if (newRow !== playerRow || newCol !== playerCol) {
        visitedCells.push({ row: playerRow, col: playerCol });
        playerRow = newRow;
        playerCol = newCol;
    }
    openCells = [];
}

var endingMessagVictoryVer = ["ì¶•í•˜í•©ë‹ˆë‹¤! ëª©í‘œ ì§€ì ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!ğŸ‰", "ìŠ¹ë¦¬! ì§€ë¢°ë°­ì„ ë¬´ì‚¬íˆ í†µê³¼í–ˆìŠµë‹ˆë‹¤!ğŸ†", "ë©‹ì§„ í”Œë ˆì´ì˜€ìŠµë‹ˆë‹¤! ëª©í‘œ ì§€ì ì— ì„±ê³µì ìœ¼ë¡œ ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. ğŸ¥³"];
var endingMessageeDefeatVer = ["ì§€ë¢°ë¥¼ ë°Ÿì•˜ìŠµë‹ˆë‹¤!ğŸ’¥", "í­ë°œ! ì§€ë¢°ë¥¼ í”¼í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤... ë‹¤ìŒì—” ë” ì‹ ì¤‘í•˜ê²Œ! ğŸ’¥", "íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë„ì „í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", "ì•„ì‰½ìŠµë‹ˆë‹¤... ì§€ë¢°ë¥¼ ë°Ÿì•„ë²„ë ¸ë„¤ìš”. ë‹¤ìŒì— ë‹¤ì‹œ ë„ì „í•˜ì„¸ìš”! ğŸ’£"];

function checkEndings(replier) {
    if (isEnd(playerRow, playerCol)) {
        var randomEndingMessageVictoryVer = endingMessagVictoryVer[Math.floor(Math.random() * endingMessagVictoryVer.length)];
        replier.reply(randomEndingMessageVictoryVer + "\n" + generateAnswerBoard());
        endGame();
    } else if (isMine(playerRow, playerCol)) {
        var randomEndingMessageDefeatVer = endingMessageeDefeatVer[Math.floor(Math.random() * endingMessageeDefeatVer.length)];
        replier.reply(randomEndingMessageDefeatVer + "\n" + generateSelfDestructAnswerBoard());
        endGame();
    }
}

function endGame() {
    gameStarted = false;
}

function generateGameBoard(hideMines) {
    var board = "";
    for (var i = 0; i < boardHeight; i++) {
        for (var j = 0; j < boardWidth; j++) {
            if (i === playerRow && j === playerCol) {
                board += "â˜…";
            } else if (isEnd(i, j)) {
                board += "â—ˆ";
            } else if (!hideMines && isMine(i, j)) {
                board += "â–£";
            } else if (openCells.some(cell => cell.row === i && cell.col === j)) {
                board += isMine(i, j) ? "â–£" : "â–¡";
            } else if (visitedCells.some(cell => cell.row === i && cell.col === j)) {
                board += "â–¡";
            } else {
                board += "â– ";
            }
        }
        board += "\n";
    }
    return board;
}

function generateSelfDestructAnswerBoard() {
    var board = "";
    for (var i = 0; i < boardHeight; i++) {
        for (var j = 0; j < boardWidth; j++) {
            if (i === playerRow && j === playerCol) {
                board += "âœ¹";
            } else if (isEnd(i, j)) {
                board += "â—ˆ";
            } else if (isMine(i, j)) {
                board += "â–£";
            } else {
                board += "â–¡";
            }
        }
        board += "\n";
    }
    return board;
}

function generateAnswerBoard() {
    var board = "";
    for (var i = 0; i < boardHeight; i++) {
        for (var j = 0; j < boardWidth; j++) {
            if (isEnd(i, j)) {
                board += "â—ˆ";
            } else if (isMine(i, j)) {
                board += "â–£";
            } else {
                board += "â–¡";
            }
        }
        board += "\n";
    }
    return board;
}

function exploreAndDisplay() {
    for (var i = playerRow - 1; i <= playerRow + 1; i++) {
        for (var j = playerCol - 1; j <= playerCol + 1; j++) {
            if (i >= 0 && i < boardHeight && j >= 0 && j < boardWidth && !visitedCells.some(cell => cell.row === i && cell.col === j) && !openCells.some(cell => cell.row === i && cell.col === j)) {
                openCells.push({ row: i, col: j });
            }
        }
    }
}

function getRandomValueInRange(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function isMine(row, col) {
    return losingCoordinates.some(coord => coord.row === row && coord.col === col);
}

function isEnd(row, col) {
    return row === boardHeight - 1 && col === boardWidth - 1;
}

function isAdjacentToStartOrEnd(row, col) {
    var startAdjacent = Math.abs(row - 0) <= 1 && Math.abs(col - 0) <= 1;
    var endAdjacent = Math.abs(row - (boardHeight - 1)) <= 1 && Math.abs(col - (boardWidth - 1)) <= 1;
    return startAdjacent || endAdjacent;
}

function replierReplyHelpMSG() { }